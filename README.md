# 基于PINN的1920×1080图像力场预测项目（支持残缺数据自动补充）

本项目是一个基于**物理信息神经网络（PINN）** 的力场预测方案，直接从1920×1080分辨率的RGB图像中预测力场分布。新增核心功能：支持对数据集中的残缺力场数据进行自动补充，采用"距离指数衰减+多源平均值"策略，解决力场数据采集困难的问题。


## 目录
1. [项目概述](#1-项目概述)
2. [环境配置](#2-环境配置)
3. [工程架构](#3-工程架构)
4. [数据集准备](#4-数据集准备)
5. [详细参数配置](#5-详细参数配置)
6. [使用流程](#6-使用流程)
7. [残缺数据补充原理](#7-残缺数据补充原理)
8. [结果解释](#8-结果解释)
9. [注意事项与问题排查](#9-注意事项与问题排查)


## 1. 项目概述
### 核心功能
- **端到端力场预测**：以1920×1080 RGB图像为输入，输出同尺寸力场分布，融合数据驱动与物理约束（力学方程）确保预测合理性。
- **残缺数据自动补充**：针对力场数据采集困难的问题，自动检测并填充缺失值，采用"距离指数衰减"策略（离已知点越远，力值衰减越快），多源已知点时取加权平均值。

### 关键特点
- 鲁棒性强：支持残缺数据场景，降低数据采集成本。
- 高可配置：网络结构、物理参数、数据填充策略均支持灵活调整。
- 全流程支持：包含数据预处理、模型训练、预测、评估及可视化。


## 2. 环境配置
### 硬件要求
- **GPU**：推荐NVIDIA显卡（如RTX 3090/4090），1920×1080图像维度较高，GPU可大幅提升训练速度。
- **CPU**：支持但训练周期长，大批次数据易内存不足。
- **内存**：至少16GB RAM（32GB及以上推荐）。
- **存储**：预留10GB+空间（数据集、模型检查点、日志）。

### 软件要求
| 依赖库          | 推荐版本       | 用途                  |
|-----------------|----------------|-----------------------|
| Python          | 3.8~3.10       | 基础编程语言          |
| PyTorch         | 1.12.0~2.0.0   | 深度学习框架          |
| NumPy           | 1.21.0+        | 数值计算（数组处理）  |
| Pillow（PIL）   | 9.0.0+         | 图像加载与预处理      |
| Matplotlib      | 3.5.0+         | 结果可视化            |
| scikit-learn    | 1.0.0+         | 评估指标计算          |
| tqdm            | 4.64.0+        | 训练进度条显示        |
| SciPy           | 1.9.0+         | 力场矩阵插值（新增）  |

### 环境安装命令
```bash
pip install torch==1.13.1+cu117 torchvision==0.14.1+cu117 --extra-index-url https://download.pytorch.org/whl/cu117
pip install numpy==1.23.5 pillow==9.3.0 matplotlib==3.6.2 scikit-learn==1.2.0 tqdm==4.64.1 scipy==1.9.3
```


## 3. 工程架构
```
pinn_force_prediction/          # 项目根目录
├── config.py                   # 全局参数配置（含数据填充参数）
├── data_loader.py              # 数据加载与预处理（新增残缺数据填充功能）
├── train.py                    # 模型训练（支持调用数据填充参数）
├── predict.py                  # 力场预测
├── evaluate.py                 # 模型评估
├── pinn.py                     # PINN核心模型
├── dataset/                    # 数据集目录
│   ├── train/                  # 训练集
│   │   ├── images/             # 训练图像（1920×1080 RGB）
│   │   └── forces/             # 训练力场标签（npy格式，支持NaN标记缺失值）
│   └── test/                   # 测试集（结构同上）
├── checkpoints/                # 模型检查点目录
├── results/                    # 训练/评估日志目录
└── predictions/                # 预测结果目录
```

### 核心文件更新说明
| 文件路径         | 新增/修改内容                                                                 |
|------------------|------------------------------------------------------------------------------|
| `data_loader.py` | 1. 新增`fill_missing_force_values`函数，实现残缺力场数据填充；<br>2. `ForceFieldDataset`类支持缺失值检测与填充；<br>3. `get_dataloaders`支持传递填充参数。 |
| `config.py`      | 1. 新增`DATA_CONFIG`中的`fill_missing`（是否启用填充）、`decay_rate`（衰减率）参数；<br>2. 新增`missing_value_indicator`（缺失值标识）。 |
| `train.py`       | 调整数据加载逻辑，支持从配置文件读取填充参数。                               |


## 4. 数据集准备
### 数据格式要求
| 数据类型   | 格式要求                                                                 | 尺寸要求                | 说明                                                                 |
|------------|--------------------------------------------------------------------------|-------------------------|----------------------------------------------------------------------|
| 图像（输入）| RGB格式，支持`jpg`/`png`                                                 | 1920×1080（H×W）        | 需与`config.py`中`DATA_CONFIG["image_size"]`一致。                  |
| 力场（标签）| NumPy数组，保存为`.npy`格式，**缺失值用NaN标记**                          | 1920×1080（H×W）        | 每个像素对应一个力值（标量），缺失值自动填充；文件名需与图像一一对应（如`img_001.jpg`对应`img_001.npy`）。 |

### 数据集目录结构示例
```
dataset/
├── train/
│   ├── images/
│   │   ├── img_001.jpg
│   │   └── ...
│   └── forces/
│       ├── img_001.npy  # 含NaN的残缺力场数据
│       └── ...
└── test/  # 结构同上
```


## 5. 详细参数配置
### 5.1 数据配置（DATA_CONFIG，新增填充相关参数）
| 参数名                  | 默认值          | 说明                                                                 |
|-------------------------|-----------------|----------------------------------------------------------------------|
| `fill_missing`          | True            | 是否自动填充残缺力场数据：`True`启用，`False`禁用（缺失值会保留为0）。 |
| `decay_rate`            | 0.1             | 指数衰减率：值越大，力值随距离衰减越快（如0.05=慢衰减，0.2=快衰减）。  |
| `missing_value_indicator` | np.nan         | 缺失值标识（默认NaN，无需修改）。                                    |
| （其他参数与原版本一致） |                 |                                                                      |

### 5.2 其他配置（保持不变）
- 基础配置（BASE_CONFIG）、PINN配置（PINN_CONFIG）、训练与评估配置（TRAIN_CONFIG）、预测配置（PREDICT_CONFIG）参数与原版本一致，详见原说明。


## 6. 使用流程
### 步骤1-3：环境搭建、数据集准备、参数配置
与原版本一致，新增操作：
- 数据集准备时，用NaN标记力场中的缺失值（如`force_field[10:20, 30:40] = np.nan`）。
- 根据力场分布特性调整`DATA_CONFIG["decay_rate"]`：若力场随距离衰减快（如局部受力），增大至0.15~0.2；若衰减慢（如全局受力），减小至0.05~0.1。

### 步骤4：训练模型
```bash
python train.py
```
- 训练过程中，程序会自动检测力场数据中的缺失值并填充，同时打印缺失值比例过高（>90%）的文件警告。

### 步骤5-6：预测与评估
与原版本一致，命令如下：
```bash
# 预测
python predict.py --model_path ./checkpoints/pinn/checkpoint_20000.pth --input ./test_image.jpg --output ./predictions

# 评估
python evaluate.py
```


## 7. 残缺数据补充原理
### 核心逻辑
对于力场矩阵中的每个缺失值（NaN），填充规则如下：
1. **查找已知点**：收集所有非NaN且非0的力值点（`(x, y, value)`）。
2. **计算距离贡献**：对每个缺失点`(i, j)`，计算其与所有已知点的欧氏距离`d`，单个已知点的贡献为：
   $$贡献 = value \times e^{-decay\_rate \times d}$$
3. **多源融合**：若缺失点周围有多个已知点，取所有贡献的平均值作为填充值。
4. **边界处理**：若无已知点，填充为0；确保填充后无剩余NaN。

### 示例效果
- 单个已知点：缺失值随距离呈指数衰减（离已知点越远，值越小）。
- 多个已知点：缺失值为各已知点贡献的平均值（平衡多源影响）。


## 8. 结果解释
与原版本一致，新增说明：
- 训练日志中会显示缺失值填充情况（如高缺失比例警告）。
- 评估指标反映填充后数据的模型拟合效果，若原始数据缺失率高，建议结合可视化结果判断合理性。


## 9. 注意事项与问题排查
### 新增问题与解决方案
| 问题现象                          | 可能原因                                  | 解决方案                                                         |
|-----------------------------------|-------------------------------------------|------------------------------------------------------------------|
| 填充结果不合理（力值分布异常）    | 衰减率设置不当或已知点过少                | 1. 调整`decay_rate`（增大/减小衰减速度）；2. 补充更多已知点数据。 |
| 程序报错“包含NaN值”                | 禁用填充后仍有缺失值                      | 1. 启用`fill_missing=True`；2. 手动处理缺失值（如填充0）。        |
| 填充速度慢                        | 力场矩阵大且缺失值多                      | 1. 减少单张图像尺寸（需同步修改`image_size`）；2. 降低`decay_rate`计算复杂度。 |

